# Mounting NFS File Systems
---

## Accessing Exported NFS Directories

The Network File System is an internet standard protocol that Linux, UNIX, and similar operating systems use as their native network file system. NFS is an open standard that supports native Linux permissions and file-system attributes.

By default, Red Hat Enterprise Linux 10 uses NFS version 4.2. RHEL 10 fully supports both NFSv3 and NFSv4 protocols. NFSv3 might use either a TCP or a UDP transport protocol. NFSv4 supports only TCP connections.

NFS servers export directories. NFS clients mount exported directories to an existing local mount point directory.

NFS clients can mount exported directories by using one of the following methods:

- Manually mount the exported directory by using the mount command.
- Persistently mount the directory at boot by using the `/etc/fstab` file.
- Automounting the directory statically on demand by using the `autofs` service.

The `mount` command does not mount the exported directory to persist after a reboot.

The `/etc/fstab` file mounts the exported directory persistently to remain mounted after a reboot. When mounting exported directories by using the `/etc/fstab` file, the following issues might occur, for example:

- The storage timeouts might increase if network issues occur.
- The timeouts also increase when the affected NFS file systems are not in use.
- Boot time issues might occur if the network is down or unreachable.

Automounting the exported directory is discussed in the next section of this chapter.

You must install the `nfs-utils` package for manual mounting, or automounting the exported NFS directories.

```bash
dnf install nfs-utils -y
```

RHEL 10 also supports mounting the shared directories from Microsoft Windows systems by using the same methods as the NFS protocol, by using either the Server Message Block (SMB) or the Common Internet File System (CIFS) protocols. Mounting options are protocol-specific, and depend on your Windows Server or Samba Server configuration. Mounting the shared directories from Microsoft Windows systems is beyond the scope of this course.

## Query Exported NFS Directories

The NFS protocol changed significantly between NFSv3 and NFSv4. The method to query a server to view the available exports is different for each protocol version.

NFSv3 uses the Remote Procedure Call (RPC) protocol, which requires a file server that supports NFSv3 connections to run the rpcbind service. An NFSv3 client connects to the rpcbind service through the 111 port on the NFS server. The server responds with the current port for the NFS service.

Use the `showmount` command to query the available exports on an RPC-based NFSv3 server.

```bash
showmount --exports server
```

The NFSv4 protocol eliminates the use of the legacy RPC protocol for NFS transactions.

NFSv4 introduces an export tree that contains all the paths for the server's exported directories. To view all the exported directories, mount the root (/) of the server's export tree.

```bash
mount server:/export mountpoint
```

Mounting the export tree provides browseable paths for all exported directories, but does not mount any of the exported directories.

```bash 
ls mountpoint
```

To mount an NFSv4 export when browsing the mounted export tree, change the current directory to an exported directory path. Alternatively, use the mount command with an exported directory's full path name to mount a single exported directory. Exported directories that use Kerberos security do not allow mounting or accessing a directory when browsing an export tree, even though you can view the export's path name. Mounting Kerberos-protected shares requires additional server configuration and the use of Kerberos user credentials, which are discussed in the Red Hat Security: Identity Management and Active Directory Integration (RH362) training course.

## Manually Mount Exported NFS Directories

After you identify the NFS export to mount, create a local mount point if it does not yet exist. Although the /mnt directory is available for use as a temporary mount point, the recommended practice is to not use `/mnt` for long-term or persistent mounting.


```bash
mkdir mountpoint
```

As with local volume file systems, mount the NFS export to access its contents.

NFS shares can be mounted temporarily or permanently, and only by a privileged user.

```bash
mount -t nfs -o rw,sync server:/export mountpoint
```

The `-t` nfs option specifies the NFS file-system type. However, when the mount command detects the server:/export syntax, the command defaults to the NFS type. With the `-o` option, you can add a list of comma-separated options to the mount command. In the example, the `rw` option specifies that the exported file system is mounted with read/write access. The `sync` option specifies synchronous transactions to the exported file system. This method is strongly recommended for all production network mounts where transactions must be completed or else return as failed.

Manual mounts are useful for providing temporary access to an exported directory, or for testing the NFS export before persistently mounting it.

## Persistently Mount Exported NFS Directories

Use the `/etc/fstab` file to persistently mount an NFS export.

This file uses syntax that is similar to the manual mounting.

```bash
...output omitted...
server:/export  mountpoint  nfs  rw  0 0
```

The `mount` command obtains the NFS server and mount options from the `/etc/fstab` file.

```bash
mount mountpoint
```

## Unmount Exported NFS Directories

As a privileged user, `unmount` an NFS export with the umount command.

```bash
umount mountpoint
```

Unmounting a share does not remove the NFS export entry from the `/etc/fstab` file. Entries in the `/etc/fstab` file are persistent and are remounted during boot.

A mounted directory can sometimes fail to unmount, and return an error that the device is busy. The device might be busy because an application has a file that is open, or a shell has a working directory in the mounted file system.

To resolve the error, close the application that has a file that is open, or check active shell windows, and use the cd command to leave the mounted file system. If subsequent attempts to unmount the file system still fail, then use the `lsof` command to query the mount point.

The `lsof` command returns a list of open file names and the process which is preventing from unmounting the exported directory.

```bash
lsof mountpoint
```

With this information, gracefully close any processes that are using files on this file system, and retry the unmount. In critical scenarios only, when an application cannot be closed gracefully, kill the process to close the file.

Alternatively, use the `umount` command `-f` option to force the unmount, which can cause the loss of unwritten data for all open files.

---
# Automounting Storage Devices
---

## Mount NFS Exports with the Automounter

The automounter (autofs) is a service that automatically mounts file systems and NFS exports on demand, and automatically unmounts them when the mounted resources are no longer in current use.

The automounter function was created to solve the problem that nonprivileged users do not have sufficient permissions to use the mount command. Without using the mount command, nonprivileged users cannot access removable media such as CDs, DVDs, and removable disk drives. Furthermore, if a local or remote file system is not mounted at boot by using the `/etc/fstab` file, then a nonprivileged user cannot mount and access those unmounted file systems.

The automounter configuration files are populated with file-system mount information, in a similar way to the `/etc/fstab` file entries. Although the `/etc/fstab` file mounts the file systems during system boot, and they remain mounted until system shutdown or other intervention, the automounter does not necessarily mount during system boot. The automounter mounts file systems on demand, when a user or application attempts to enter the file-system mount point to access files.

### Automounter Benefits

Automounter uses equivalent resources to file systems that are mounted at boot, because a file system uses resources only when a program is reading or writing open files. Mounted and idle file systems, and unmounted file systems, use almost no resources.

The advantage of an automounter is that, by unmounting the file system each time that it is no longer in use, the file system is protected from unexpected corruption when it is open. When the file system is directed to mount again, the `autofs` service uses the most current mount configuration, unlike the `/etc/fstab` file, which might still use a configuration that was mounted months ago during the last system boot. Additionally, if your NFS server configuration includes redundant servers and paths, then the automounter can select the fastest connection each time that a new file system is requested.

### The Automounter Service

The automounter service supports the same local and remote file systems as in the `/etc/fstab` file, including NFS and SMB file sharing protocols, and supports the same protocol-specific mount options, including security parameters. File systems that are mounted through the automounter are available by default to all users, but can be restricted through access permission options.

Because the automounter is a client-side configuration that uses the standard mount and umount commands to manage file systems, automounted file systems in use exhibit the same behavior to file systems that are mounted by using the `/etc/fstab` file. The difference is that an automounter file system remains unmounted until the mount point is accessed, which causes the file system to mount immediately, and to remain mounted when the file system is in use. When all files on the file system are closed, and all users and processes leave the mount point directory, the automounter unmounts the file system after a minimal timeout.

### Direct and Indirect Map Use Cases

The `autofs` service supports both direct and indirect mount-point mapping, to handle the two types of mounting.

A direct mount is when a file system mounts to an unchanging, known mount point location. A direct mount point exists as a permanent directory.

An indirect mount is when the mount point location is not known until the mount demand occurs. Although indirect mount points appear to exist, the `autofs` service creates them when the mount demand occurs, and deletes them again when the demand ended and the file system is unmounted.

## Configure the Automounter Service

To use the `autofs` service, you must install the `autofs` and `nfs-utils` packages.

```bash
dnf install autofs nfs-utils
```

## The Master Map File

The `autofs` service uses the `/etc/auto.master` file as the default master map configuration file. You can use the `/etc/autofs.conf` file to change the map file for the autofs service.

Use the `/etc/auto.master.d` directory to configure the master map file. This file identifies the base directory for mount points, and identifies the mapping file to create the automounts.

The name of the master map file is mostly arbitrary (although typically meaningful), and it must have the `.autofs` extension for the subsystem to recognize it. You can place multiple entries in a single master map file; alternatively, you can create multiple master map files, each with its own logically grouped entries.

The master map uses the following format for automounting:

```bash
cat /etc/auto.master.d/demo.autofs
```

Replace the `mountpoint` variable with the directory to use as the mount point.

Replace the `map-file` variable with the file to use as the map file. The map file must be created before starting the `autofs` service.

## The Map File

Map files configure the properties of individual on-demand mount points.

The automounter creates the directories if they do not exist. If the directories exist before the automounter starts, then the automounter does not remove them when it exits. If a timeout is specified, then the directory is automatically unmounted if the directory is not accessed for the timeout period.

If you use a single directory name for the mount point, then the directory is mounted as an indirect mount. If you use the full path for the mount point, then the directory is mounted as a direct mount.

The map file uses the following format for automounting:

```bash
cat /etc/auto.demo
```
```bash
mountpoint     mount-options     source-location
```

Replace the `mountpoint` variable with the directory to use as the mount point.

Replace the `mount-options` variable with the options to use for mounting the automount.

Replace the `source-location` variable with the source location of the mount.

### Create a Direct Map File

A direct map file maps an NFS export to an absolute path mount point. Only one direct map file is necessary, and can contain any number of direct maps.

To use directly mapped mount points, include the following content in the master map file:

```bash
cat /etc/direct.autofs
```
```bash
/-  /etc/auto.direct
```

The naming convention for a map file is `/etc/auto.name`, where name reflects the content of the map.

All direct map entries use the `/-` path as the base directory. In this case, the `/etc/auto.direct` mapping file contains the mount details.

The following example shows a sample entry in the map file:

```bash
cat /etc/auto.direct
```
```bash
/mnt/docs  -rw,sync  hosta:/shares/docs
```

The mount point is always an absolute path. The rest of the mapping file uses the same structure.

In this example, the `/mnt` directory exists, and the autofs service does not manage it. The autofs service creates and removes the full `/mnt/docs` directory automatically.

### Create an Indirect Map File

Each mapping file identifies the mount point, mount options, and the source location to mount for a set of automounts.

For indirect automounting, include the following content in the master map file:

```bash
cat /etc/auto.master.d/indirect.autofs
```
```bash
/shares  /etc/auto.indirect
```

This entry uses the `/shares` directory as the base mount point for the indirect automount. The `/etc/auto.indirect` map file contains the mount details.

The following example shows a sample entry in the map file:

```bash
cat /etc/auto.indirect
```
```bash
work  -rw,sync  hosta:/shares/work
```

The naming convention for a map file is `/etc/auto.name`, where name reflects the content of the map.

The fully qualified mount point is the `/shares/work` directory. The autofs service creates and removes the `/shares` and `/shares/work` directories as needed.

In this example, the local mount point mirrors the server's directory structure. However, this mirroring is not required; the local mount point can have an arbitrary name. The autofs service does not enforce a specific naming structure on the client.

Mount options start with a dash character (`-`) and are comma-separated with no white space. The file-system mount options for manual mounting are also available when automounting. In this example, the automounter mounts the export with read/write access (`rw` option), and the server is synchronized immediately during write operations (`sync` option).

Useful automounter-specific options include the `-fstype=` or `-strict` options. Use the `fstype` option to specify the file-system type, for example NFS4 or XFS, and use the strict option to treat errors as fatal when mounting file systems.

The source location for NFS exports follows the `host:/pathname` pattern, in this example `hosta:/shares/work`. For this automount to succeed, the NFS server, hosta, must export the directory with read/write access, and the user that requests access must have standard Linux file permissions on the directory. If the `hosta` machine exports the directory with read-only access, then the client gets read-only access even if the client requested read/write access.

### Using Wildcards in Map Files

When an NFS server exports multiple subdirectories within a directory, the automounter can then be configured to access any of those subdirectories with a single mapping entry.

Continuing the previous example, if the `hosta:/shares` export contains two or more subdirectories, and they are accessible with the same mount options, then the entry for the `/etc/auto.indirect` file might appear as follows:

```bash
cat /etc/auto.indirect
```
```bash
*  -rw,sync  hosta:/shares/&
```

The mount point (or key) is an asterisk character (`*`), and the subdirectory on the source location is an ampersand character (`&`). Everything else in the entry is the same.

When a user attempts to access the `/shares/work` directory, the `*` key (which is work in this example) replaces the ampersand in the source location, and the `hosta:/shares/work` export is mounted. As with the indirect map file example, the autofs service creates and removes the work directory automatically.

## Start the Automounter Service

After you have configured the master map and map files, use the systemctl command to start and enable the autofs service.

```bash
systemctl enable --now autofs
```

## The Alternative Automount Method

The `systemd` daemon can automatically create unit files for entries in the `/etc/fstab` file that include the `x-systemd.automount` option. Use the systemctl daemon-reload command to update the systemd daemon of the new configuration file. Then, use the `systemctl start unit.automount` command to enable the automount configuration.

The naming of the unit is based on its mount location. For example, if the mount point is `/remote/finance`, then the unit file is named `remote-finance.automount`. The systemd daemon mounts the file system when the `/remote/finance` directory is initially accessed.

This method can be simpler than installing and configuring the `autofs` service. However, a `systemd.automount` unit can support only absolute path mount points, similar to the `autofs` direct maps.



